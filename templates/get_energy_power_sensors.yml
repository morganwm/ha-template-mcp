description: >-
  Get all energy and power consumption sensors throughout the system.
  This provides current power usage and energy consumption readings organized by area.

  When to use:
    - Monitoring real-time power consumption
    - Tracking energy usage across different devices
    - Identifying high-power consuming devices
    - Understanding energy patterns throughout the home

  Tips:
    - Sensors are grouped by area for easy location-based comparison
    - Includes both power (instantaneous) and energy (cumulative) sensors
    - Sensors without an assigned area are grouped under "no_area"
    - Power is typically measured in W (watts), energy in kWh (kilowatt-hours)

template: >-
  {%- set power_sensors = states.sensor
    | selectattr('attributes.device_class', '==', 'power')
    | list -%}
  {%- set energy_sensors = states.sensor
    | selectattr('attributes.device_class', '==', 'energy')
    | list -%}

  {#- Build a mapping of area -> sensors -#}
  {%- set by_area = namespace(data={}) -%}

  {%- for sensor in power_sensors + energy_sensors -%}
    {%- set area_name = area_name(sensor.entity_id) if area_id(sensor.entity_id) else 'no_area' -%}
    {%- set sensor_type = sensor.attributes.device_class -%}

    {#- Initialize area if not exists -#}
    {%- if area_name not in by_area.data -%}
      {%- set by_area.data = dict(by_area.data, **{area_name: {'power': [], 'energy': []}}) -%}
    {%- endif -%}

    {%- set sensor_info = {
      'entity_id': sensor.entity_id,
      'name': sensor.name if sensor.name else sensor.attributes.friendly_name,
      'value': sensor.state if sensor.state not in ['unavailable', 'unknown'] else none,
      'unit': sensor.attributes.unit_of_measurement if sensor.attributes.unit_of_measurement is defined else none
    } -%}

    {%- if sensor_type == 'power' -%}
      {%- set current = by_area.data[area_name]['power'] -%}
      {%- set by_area.data = dict(by_area.data, **{area_name: dict(by_area.data[area_name], power=current + [sensor_info])}) -%}
    {%- elif sensor_type == 'energy' -%}
      {%- set current = by_area.data[area_name]['energy'] -%}
      {%- set by_area.data = dict(by_area.data, **{area_name: dict(by_area.data[area_name], energy=current + [sensor_info])}) -%}
    {%- endif -%}
  {%- endfor -%}

  {{- by_area.data | to_json -}}
